generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Mission {
  id         String   @id @default(cuid())
  text       String
  type       String   // 'START', 'MID' ou 'LATE'
  category   String
  difficulty String   // 'easy', 'medium', 'hard'
  points     Int      // 100 (easy), 200 (medium), 500 (hard)
  isPrivate  Boolean  @default(false)
  createdAt  DateTime @default(now())

  playerMissions PlayerMission[]

  @@index([type])
}

model Room {
  id               String    @id @default(cuid())
  code             String    @unique
  creatorToken     String
  gameType         String    @default("aram-missions")
  gameStarted      Boolean   @default(false)
  gameStartTime    DateTime?
  gameStopped      Boolean   @default(false)
  validationStatus String    @default("not_started") // 'not_started', 'in_progress', 'completed'
  midMissionDelay  Int       @default(480)            // en secondes, défaut 5 min
  lateMissionDelay Int       @default(960)            // en secondes, défaut 10 min
  createdAt        DateTime  @default(now())

  players          Player[]

  @@index([code])
}

model Player {
  id        String   @id @default(cuid())
  name      String
  token     String   @unique
  avatar    String   @default("")
  team      String   @default("")   // "" = spectateur, "red" ou "blue"
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  missions PlayerMission[]

  @@index([roomId])
  @@index([token])
}

model PlayerMission {
  id           String   @id @default(cuid())
  playerId     String
  player       Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  missionId    String
  mission      Mission  @relation(fields: [missionId], references: [id])
  type         String   // 'START', 'MID' ou 'LATE'
  validated    Boolean  @default(false)
  pointsEarned Int      @default(0)
  decided      Boolean  @default(false) // true dès que le créateur a traité cette mission
  assignedAt   DateTime @default(now())

  @@unique([playerId, type])
  @@index([playerId])
}