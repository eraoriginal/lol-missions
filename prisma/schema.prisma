generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Mission {
  id         String   @id @default(cuid())
  text       String
  type       String   // 'START', 'MID' ou 'LATE'
  category   String
  difficulty String   // 'easy', 'medium', 'hard'
  createdAt  DateTime @default(now())

  playerMissions PlayerMission[]

  @@index([type])
}

model Room {
  id              String    @id @default(cuid())
  code            String    @unique
  creatorToken    String
  gameStarted     Boolean   @default(false)
  gameStartTime   DateTime?
  createdAt       DateTime  @default(now())

  players         Player[]
  messages        Message[] // Relation messages

  @@index([code])
}

model Player {
  id              String   @id @default(cuid())
  name            String
  token           String   @unique // Token unique du joueur
  avatar          String   @default("") // Avatar du joueur
  roomId          String
  room            Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  missions        PlayerMission[]

  @@index([roomId])
  @@index([token])
}

model PlayerMission {
  id              String   @id @default(cuid())
  playerId        String
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  missionId       String
  mission         Mission  @relation(fields: [missionId], references: [id])
  type            String   // 'START', 'MID' ou 'LATE'
  assignedAt      DateTime @default(now())
  
  @@unique([playerId, type])
  @@index([playerId])
}

model Message {
  id        String   @id @default(cuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  playerId  String
  playerName String  // Dénormalisé pour performance
  playerAvatar String @default("")
  content   String
  createdAt DateTime @default(now())

  @@index([roomId])
  @@index([createdAt])
}