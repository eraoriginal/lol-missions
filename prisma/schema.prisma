generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Event {
  id         String   @id @default(cuid())
  text       String
  type       String   // 'START', 'MID' ou 'LATE'
  category   String
  difficulty String   // 'easy', 'medium', 'hard'
  points     Int
  createdAt  DateTime @default(now())

  @@index([type])
}

model Mission {
  id         String   @id @default(cuid())
  text       String
  type       String   // 'START', 'MID' ou 'LATE'
  category   String
  difficulty String   // 'easy', 'medium', 'hard'
  points     Int      // 100 (easy), 200 (medium), 300 (hard)
  isPrivate  Boolean  @default(false)
  maps       String   @default("all")   // "howling_abyss", "summoners_rift" ou "all"
  createdAt  DateTime @default(now())

  playerMissions PlayerMission[]

  @@index([type])
}

model Room {
  id                  String    @id @default(cuid())
  code                String    @unique
  creatorToken        String
  gameType            String    @default("aram-missions")
  gameStarted         Boolean   @default(false)
  gameStartTime       DateTime?
  gameStopped         Boolean   @default(false)
  validationStatus    String    @default("not_started") // 'not_started', 'in_progress', 'completed'
  midMissionDelay     Int       @default(480)            // en secondes, défaut 5 min
  lateMissionDelay    Int       @default(960)            // en secondes, défaut 10 min
  missionVisibility   String    @default("team")         // 'all', 'team', 'hidden'
  gameMap             String    @default("howling_abyss") // 'howling_abyss', 'summoners_rift'
  victoryBonus        Boolean   @default(true)            // bonus de 0-500 pts pour l'équipe victorieuse
  winnerTeam          String?                             // "red" ou "blue", null si pas encore défini
  victoryBonusPoints  Int       @default(0)              // points bonus attribués à l'équipe gagnante
  selectedCategories  String[]  @default([])             // catégories sélectionnées pour Codename
  createdAt           DateTime  @default(now())

  players          Player[]
  codenameGame     CodenameGame?
  gameHistories    GameHistory[]

  @@index([code])
}

model GameHistory {
  id                 String   @id @default(cuid())
  roomId             String
  room               Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  gameNumber         Int      // 1, 2, 3... (numéro de la partie dans cette room)

  // Résultats
  redScore           Int      // Total points équipe rouge
  blueScore          Int      // Total points équipe bleue
  winnerTeam         String?  // "red", "blue" ou null (égalité)
  victoryBonusPoints Int      @default(0)
  bonusTeam          String?  // Équipe qui a reçu le bonus

  // Snapshot des joueurs et missions (JSON pour simplicité)
  playersSnapshot    String   // JSON: [{ name, team, avatar, missions: [{ text, type, validated, points }] }]

  playedAt           DateTime @default(now())

  @@index([roomId])
}

model Player {
  id        String   @id @default(cuid())
  name      String
  token     String   @unique
  avatar    String   @default("")
  team      String   @default("")   // "" = spectateur, "red" ou "blue"
  role      String?  // "spymaster" or "operative" for Codenames
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  missions PlayerMission[]

  @@index([roomId])
  @@index([token])
}

model PlayerMission {
  id           String   @id @default(cuid())
  playerId     String
  player       Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  missionId    String
  mission      Mission  @relation(fields: [missionId], references: [id])
  type         String   // 'START', 'MID' ou 'LATE'
  validated    Boolean  @default(false)
  pointsEarned Int      @default(0)
  decided      Boolean  @default(false) // true dès que le créateur a traité cette mission
  assignedAt   DateTime @default(now())

  @@unique([playerId, type])
  @@index([playerId])
}

// Codename du CEO - Word bank
model CodenameWord {
  id        String   @id @default(cuid())
  word      String   @unique
  category  String?  // optional categorization (champions, items, places, etc.)
  createdAt DateTime @default(now())
}

// Codename du CEO - Game state
model CodenameGame {
  id            String   @id @default(cuid())
  roomId        String   @unique
  room          Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  currentTeam   String   @default("red")  // "red" or "blue"
  redRemaining  Int      @default(9)
  blueRemaining Int      @default(8)
  gameOver      Boolean  @default(false)
  winner        String?  // "red", "blue", or null

  currentClue   String?
  currentNumber Int?
  guessesLeft   Int      @default(0)

  cards         CodenameCard[]
  history       CodenameHistory[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Codename du CEO - Game history (clues and guesses)
model CodenameHistory {
  id         String       @id @default(cuid())
  gameId     String
  game       CodenameGame @relation(fields: [gameId], references: [id], onDelete: Cascade)

  team       String       // "red" or "blue"
  type       String       // "clue" or "guess"
  clue       String?      // if type is "clue"
  number     Int?         // if type is "clue"
  cardWord   String?      // if type is "guess"
  cardColor  String?      // if type is "guess"

  createdAt  DateTime     @default(now())

  @@index([gameId])
}

// Codename du CEO - Individual cards on the board
model CodenameCard {
  id        String        @id @default(cuid())
  gameId    String
  game      CodenameGame  @relation(fields: [gameId], references: [id], onDelete: Cascade)

  word      String
  category  String?       // category of the word
  color     String        // "red", "blue", "neutral", "assassin"
  revealed  Boolean       @default(false)
  position  Int           // 0-24 for grid position

  interests CardInterest[]

  @@unique([gameId, position])
  @@index([gameId])
}

// Codename du CEO - Player interest/pre-selection on cards
model CardInterest {
  id         String       @id @default(cuid())
  cardId     String
  card       CodenameCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  playerName String
  createdAt  DateTime     @default(now())

  @@unique([cardId, playerName])
  @@index([cardId])
}